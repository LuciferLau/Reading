# 简读笔记

---

## 第八章 内存管理

在计算机系统里，RAM一般用作内存，ROM一般作为固件，用来存放一些硬件的驱动程序。  
RAM将某些部分永久地分配给内核，用来存放内核代码以及静态内核数据结构，其余部分称为动态内存，  
计算机系统的性能取决于如何有效地管理内存，现在所有的多任务操作系统都在尽力优化对动态内存的使用，  
尽可能做到需要时分配，不需要时释放。  

---

### 名词释义
MA是在本章高频提到的缩写，即 Memory Access 内存访问。  
DMA：Direct 直接内存访问；  
NUMA：Non-Uniform 非一致内存访问；  
UMA：Uniform 一致内存访问；  
RAM：Random Access Memory 随机存取存储器，分为S（tatic）RAM，D（ynamic）RAM，又名主存，内存；    
ROM：Read-Only Memory 只读存储器，最常见的 CD-ROM，断电后不会丢失数据，但读写速度较慢；  

### 伙伴系统算法
目的：解决外碎片问题，即频繁分配和释放不同大小的连续页框中产生的，  
已分配页框中存在许多小块的空闲页框，从而导致无法再次申请大块连续页框。  

核心思想：按需分配，既然不想为了满足小块的请求而分割大的空闲块，那就先准备好各种size的块任君选择。  
Linux的 buddy system 就是将所有的空闲页框分组为 11 个块链表，每个块链表分别包含大小为  
1， 2， 4， 8， 16， 32， 64， 128， 256， 512， 1024 个连续的页框，对应块字节大小为  
4KB，8KB，16KB，32KB，64KB，128KB，256KB，512KB，1MB，2MB，4MB  

当需要一个 1MB 的块内存时，算法会先从 256 个连续页框的链表内找一个空闲的块，  
- 1 如果找得到，直接将这个块分配给所需；  
- 2 如果找不到，寻找 512 个连续页框的链表，  
- 2-1 如果找到了，对半拆分这个块（512->256*2），一半插入上一级的链表，另一半用于分配给所需；   
- 2-2 如果找不到，寻找 1024 个连续页框的链表;
- 2-2-1 如果找到了，类同2-1，将 256 用于分配，剩下的 768 拆分为 512 和 256 插入对应链表；
- 2-2-2 还是找不到，放弃，发出错误信号。  

在内存释放时，算法会尝试将2个大小相同的块合成为一个2倍大小的块，但需要满足以下条件：  
- 大小相同，记为b
- 物理地址连续
- 第一块的第一个页框的物理地址是 2 * b * 2<sup>12</sup> 的倍数

如果满足条件，算法会迭代执行直到合成最大的快。
